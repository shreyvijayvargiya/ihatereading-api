import autocannon from "autocannon";
import { performance } from "perf_hooks";

// Resource monitoring
const startMemory = process.memoryUsage();
const startTime = performance.now();

// Test configuration
const testConfig = {
    url: "http://localhost:3001/scrap-url-puppeteer",
    connections: 10, // 10 concurrent connections
    amount: 1000, // Exactly 1,000 requests
    pipelining: 1,
    requests: [
        {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                url: "https://dev.to/shreyvijayvargiya/build-a-custom-saas-crm-in-hours-not-months-with-this-react-nextjs-template-14pd",
                includeImages: false, // Keep it light to see if it even survives
                includeCache: false,
                timeout: 30000,
                includeSemanticContent: true,
                includeLinks: false,
                extractMetadata: true,
            }),
        },
    ],
};

console.log("ğŸ”¥ Starting 1,000 Request Pentest...");
console.log(`ğŸ“Š Target: ${testConfig.url}`);
console.log(`ğŸ”— Concurrent Connections: ${testConfig.connections}`);
console.log(`ğŸ“ Total requests: ${testConfig.amount}`);

const instance = autocannon(testConfig, (err, result) => {
    if (err) {
        console.error("âŒ Test failed:", err);
        process.exit(1);
    }

    console.log("\nğŸ“Š Pentest Final Results:");
    console.log("=======================");
    console.log(`ğŸƒâ€â™‚ï¸  Total Requests: ${result.requests.total}`);
    console.log(`âœ… Average RPS: ${result.requests.average}`);
    console.log(`â±ï¸  Average Latency: ${result.latency.average}ms`);
    console.log(`âŒ Total Errors: ${result.errors}`);
    console.log(`â° Total Duration: ${result.duration}s`);

    const rps = result.requests.total / result.duration;
    console.log(`ğŸš€ Requests/sec: ${rps.toFixed(2)}`);

    console.log("\nğŸ’¾ Resource Summary:");
    const currentMemory = process.memoryUsage();
    console.log(`ğŸ§  RSS Memory: ${(currentMemory.rss / 1024 / 1024).toFixed(2)} MB`);
    console.log(`ğŸ“ˆ RSS Growth: ${((currentMemory.rss - startMemory.rss) / 1024 / 1024).toFixed(2)} MB`);

    process.exit(0);
});

instance.on("tick", (results) => {
    if (results && results.requests) {
        console.log(`âš¡ Progress: ${results.requests.total}/${testConfig.amount} | Current RPS: ${results.requests.average}`);
    }
});

instance.on("done", () => {
    console.log("\nğŸ Pentest finished!");
});
